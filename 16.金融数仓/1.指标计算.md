# 消金领域指标的计算与刨析

- 在消费金融数仓建设中，关于建模分层的理论与实践方案已十分成熟，各类文章与机构常对其具体路径、设计规范展开详细拆解。但在实际业务场景中，**核心指标的落地计算逻辑**，以及数仓如何通过 DWD（数据仓库明细层）支撑指标实现，相关的实操方案却较为稀缺。本文将聚焦消金领域高频指标，拆解其定义、计算方法与业务价值。

## 常用指标

### **还款计划表**：

- 还款计划表虽不属于指标范畴，却是消金领域所有核心指标计算的 “数据基石”。作为 DWD 层的核心明细事实表，它记录了每笔贷款从发放到结清的全生命周期关键信息，具体可提取维度与事实如下：

1. **借据基础信息**：借据编号、客户 ID、产品类型等唯一标识与分类维度；

- **放款核心数据**：放款日期、放款金额、合同期数（总期数）；

- **还款计划明细**：每期应还日期、应还本金、应还利息、应还总额；

- **还款状态跟踪**：每期实还日期、实还本金、实还利息、实还总额，及当期状态（未还、已还、部分还款、代偿、回购）。

这张表的完整性与准确性，直接决定了后续所有指标计算的精度，因此在 DWD 层通常采用 “每日全量覆盖 + 历史切片存储” 的方式，确保数据可追溯、可重复调用。

### 在贷：

- **含义**：指截至某个特定时间点，尚未结清的贷款业务。在贷指标可以从多个维度进行分析，如在贷余额、在贷户数等。
- **计算**：在贷余额通常是通过将所有未结清贷款的剩余本金相加得到。例如，有三笔贷款，剩余本金分别为 1000 元、2000 元、3000 元，则在贷余额为 1000+2000+3000=6000 元。在贷户数就是未结清贷款的客户数量。

### vintage：

- **含义**：Vintage 分析是一种将贷款按照放款时间进行分组，然后观察每组贷款在不同账龄阶段的表现情况的方法，它可以帮助金融机构了解贷款资产的质量随时间的变化趋势。
- **计算**：首先需要确定放款月份和账龄（MOB）。放款月份是指贷款发放的月份，账龄是指贷款自发放之日起至当前时间的月数。然后，根据不同的分析需求，计算每个放款月份组在不同账龄下的相关指标，如逾期率、回收率等。例如，计算 2025 年 1 月放款的贷款在 MOB=3 时的逾期率，需要统计该组贷款中逾期天数超过 30 天（假设 M1 为逾期 1-30 天）的贷款金额或户数，再除以该组在 MOB=3 时的在贷余额或在贷户数。

### MOB：

- **含义**：即账龄，反映了贷款在账上的时间长度，是评估贷款风险的重要指标之一。
- **计算**：MOB = 当前日期−放款日期，通常以月为单位进行计算。例如，某笔贷款于 2025 年 8 月 1 日发放，当前日期为 2025 年 9 月 15 日，则该笔贷款的 MOB 为 1 个月（因为 9 月 15 日距离 8 月 1 日不足 2 个月）。

### fpd：

- **含义**：首次还款逾期指标，用于衡量新放款客户的早期还款行为，帮助金融机构识别潜在的高风险借款人。
- **计算**：在首次还款期限内，统计未能按时还款的贷款数量或金额，然后除以该期限内新放款的贷款总数或总金额。例如，某金融机构在 2025 年 9 月新放款 100 笔贷款，其中 5 笔在首次还款期限内未能偿还，则 FPD（假设首次还款期限为 15 天）的比例为 5÷100=5%。

### dpd：

- **含义**：逾期天数，指从应还款日期起算，至实际还款日期止的天数，用于衡量贷款逾期的严重程度。
- **计算**：DPD = 实际还款日期−应还款日期。例如，某笔贷款应还日期为 2025 年 9 月 10 日，实际还款日期为 2025 年 9 月 20 日，则该笔贷款的 DPD 为 10 天。

## 指标计算

- 在消费金融领域，Vintage 分析是评估资产质量的核心工具。风控从业者通常习惯用 Python 实现，但在企业级数仓环境中，使用 SQL 能更好地适配海量数据处理场景，同时满足工程化落地的稳定性与可复用性要求。

- 要在 SQL 中正确计算 Vintage，关键是遵循数仓设计的三大原则：

  1. **任务可重复执行**：重跑历史数据不应影响当前结果。
  2. **数据链路无循环**：下游计算不应依赖上游的历史输出。
  3. **计算逻辑与时间解耦**：同一套代码应能复用于任意时间窗口。

- 要满足这些原则，核心在于**构建一张高质量的、修复过的还款计划表** (`dwd_repayment_schedule`)。这张表记录了每笔借据每期的应还与实还信息，是所有计算的 “单一事实来源”。

  基于此表，我们可以加工出每笔借据每期的状态及其生命周期（开始 / 结束时间）。作为 DWD 层的明细事实表，它既可以：

  - **每日全量覆盖**：保证数据最新最全，适合数据量不大或修复频繁的场景。
  - **按应还日增量更新**：将`due_date`设为分区键，每日仅处理到期或逾期的数据，性能更高。

  无论采用哪种方式，这张表都能确保任务的幂等性和可重复执行性，为上层 Vintage 指标的计算提供坚实、可靠的数据基础。

## 实际数据示例

### 一、基础还款计划数据（1000 元 12 期年化 12%，正常还款）

- 首先构建该笔借据的完整还款计划表

| 借据编号      | 期数 | 放款金额（元） | 放款日期   | 应还日期   | 实还日期   | 应还本金（元） | 实还本金（元） | 应还利息（元） | 实还利息（元） |
| ------------- | ---- | -------------- | ---------- | ---------- | ---------- | -------------- | -------------- | -------------- | -------------- |
| L202509220001 | 1    | 1000.00        | 2025-09-22 | 2025-10-22 | 2025-10-22 | 78.85          | 78.85          | 10.00          | 10.00          |
| L202509220001 | 2    | 1000.00        | 2025-09-22 | 2025-11-22 | 2025-11-22 | 79.54          | 79.54          | 9.31           | 9.31           |
| L202509220001 | 3    | 1000.00        | 2025-09-22 | 2025-12-22 | 2025-12-22 | 80.24          | 80.24          | 8.61           | 8.61           |
| L202509220001 | 4    | 1000.00        | 2025-09-22 | 2026-01-22 | 2026-01-22 | 80.94          | 80.94          | 7.91           | 7.91           |
| L202509220001 | 5    | 1000.00        | 2025-09-22 | 2026-02-22 | 2026-02-22 | 81.65          | 81.65          | 7.20           | 7.20           |
| L202509220001 | 6    | 1000.00        | 2025-09-22 | 2026-03-22 | 2026-03-22 | 82.37          | 82.37          | 6.48           | 6.48           |
| L202509220001 | 7    | 1000.00        | 2025-09-22 | 2026-04-22 | 2026-04-22 | 83.10          | 83.10          | 5.75           | 5.75           |
| L202509220001 | 8    | 1000.00        | 2025-09-22 | 2026-05-22 | 2026-05-22 | 83.84          | 83.84          | 5.01           | 5.01           |
| L202509220001 | 9    | 1000.00        | 2025-09-22 | 2026-06-22 | 2026-06-22 | 84.58          | 84.58          | 4.27           | 4.27           |
| L202509220001 | 10   | 1000.00        | 2025-09-22 | 2026-07-22 | 2026-07-22 | 85.34          | 85.34          | 3.51           | 3.51           |
| L202509220001 | 11   | 1000.00        | 2025-09-22 | 2026-08-22 | 2026-08-22 | 86.11          | 86.11          | 2.74           | 2.74           |
| L202509220001 | 12   | 1000.00        | 2025-09-22 | 2026-09-22 | 2026-09-22 | 86.88          | 86.88          | 1.97           | 1.97           |
| **合计**      | -    | 1000.00        | -          | -          | -          | 1000.00        | 1000.00        | 66.76          | 66.76          |

### 二、借据生命周期加工：start_date 与 end_date

1. **start_date（周期起始日）**：

   - 核心逻辑：明确每期还款对应的 “借贷周期起始时间”，首期因尚未产生历史应还记录，直接关联放款日期（2025-09-22），体现 “放款即开启第一期还款周期” 的业务逻辑；

   - 非首期（2-12 期）均取上一期的 “应还日期” 作为当期起始日，例如第 2 期 start_date = 第 1 期应还日（2025-10-22），形成 “上一期还款截止 = 当期周期开始” 的连续链路，符合消费金融 “按月循环还款” 的周期划分习惯。

2. **end_date（周期结束日）**：
   - 统一逻辑：直接取当期 “应还日期”，既与还款计划的核心履约节点对齐，也明确了 “每期还款需在当期 end_date 前完成” 的业务约束，例如第 3 期 end_date=2025-12-22（当期应还日），与实还日期（2025-12-22）一致，体现 “按时还款” 场景下周期结束与履约完成的同步性。

| 借据编号      | 期数 | 放款金额（元） | 放款日期   | 应还日期   | 实还日期   | 应还本金（元） | 实还本金（元） | 应还利息（元） | 实还利息（元） | start_date（周期起始日）     | end_date（周期结束日）     |
| ------------- | ---- | -------------- | ---------- | ---------- | ---------- | -------------- | -------------- | -------------- | -------------- | ---------------------------- | -------------------------- |
| L202509220001 | 1    | 1000.00        | 2025-09-22 | 2025-10-22 | 2025-10-22 | 78.85          | 78.85          | 10.00          | 10.00          | 2025-09-22（首期取放款日）   | 2025-10-22（取当期应还日） |
| L202509220001 | 2    | 1000.00        | 2025-09-22 | 2025-11-22 | 2025-11-22 | 79.54          | 79.54          | 9.31           | 9.31           | 2025-10-23（取上一期应还日） | 2025-11-22（取当期应还日） |
| L202509220001 | 3    | 1000.00        | 2025-09-22 | 2025-12-22 | 2025-12-22 | 80.24          | 80.24          | 8.61           | 8.61           | 2025-11-23（取上一期应还日） | 2025-12-22（取当期应还日） |
| L202509220001 | 4    | 1000.00        | 2025-09-22 | 2026-01-22 | 2026-01-22 | 80.94          | 80.94          | 7.91           | 7.91           | 2025-12-23（取上一期应还日） | 2026-01-22（取当期应还日） |
| L202509220001 | 5    | 1000.00        | 2025-09-22 | 2026-02-22 | 2026-02-22 | 81.65          | 81.65          | 7.20           | 7.20           | 2026-01-23（取上一期应还日） | 2026-02-22（取当期应还日） |
| L202509220001 | 6    | 1000.00        | 2025-09-22 | 2026-03-22 | 2026-03-22 | 82.37          | 82.37          | 6.48           | 6.48           | 2026-02-23（取上一期应还日） | 2026-03-22（取当期应还日） |
| L202509220001 | 7    | 1000.00        | 2025-09-22 | 2026-04-22 | 2026-04-22 | 83.10          | 83.10          | 5.75           | 5.75           | 2026-03-23（取上一期应还日） | 2026-04-22（取当期应还日） |
| L202509220001 | 8    | 1000.00        | 2025-09-22 | 2026-05-22 | 2026-05-22 | 83.84          | 83.84          | 5.01           | 5.01           | 2026-04-23（取上一期应还日） | 2026-05-22（取当期应还日） |
| L202509220001 | 9    | 1000.00        | 2025-09-22 | 2026-06-22 | 2026-06-22 | 84.58          | 84.58          | 4.27           | 4.27           | 2026-05-23（取上一期应还日） | 2026-06-22（取当期应还日） |
| L202509220001 | 10   | 1000.00        | 2025-09-22 | 2026-07-22 | 2026-07-22 | 85.34          | 85.34          | 3.51           | 3.51           | 2026-06-23（取上一期应还日） | 2026-07-22（取当期应还日） |
| L202509220001 | 11   | 1000.00        | 2025-09-22 | 2026-08-22 | 2026-08-22 | 86.11          | 86.11          | 2.74           | 2.74           | 2026-07-23（取上一期应还日） | 2026-08-22（取当期应还日） |
| L202509220001 | 12   | 1000.00        | 2025-09-22 | 2026-09-22 | 2026-09-22 | 86.88          | 86.88          | 1.97           | 1.97           | 2026-08-23（取上一期应还日） | 2026-09-22（取当期应还日） |
| **合计**      | -    | 1000.00        | -          | -          | -          | 1000.00        | 1000.00        | 66.76          | 66.76          | -                            | -                          |

**业务价值**：

   新增字段后，可直接通过 “start_date~end_date” 定位每笔还款的归属周期，例如后续计算 MOB（账龄）时，可基于 “放款日期与 start_date 的间隔” 判断账龄阶段，也可通过 “end_date 与实还日期的差” 快速计算逾期天数（DPD），为 Vintage 等风控指标的 SQL 计算提供更直接的周期维度数据支撑。

### 三、借据每日状态扩展：关联日期维度表实现 “按日追踪”

现有还款计划表已包含每期start_date（周期起始日）和end_date（周期结束日），结合**日期维度表（如****dim_date****，含每日日期、是否月末等标记）**，可生成借据 “每日状态快照”，为后续指标计算提供最小粒度数据。

#### 1. 核心关联逻辑

以借据L202509220001为例，通过 “日期维度表日期 ∈ 当期 start_date~end_date” 的关联条件，将每期还款计划拆分为每日记录，补充当日关键状态字段：

| 借据编号      | 日期       | 所属期数 | 当期 start_date | 当期 end_date | 当日应还本金（元） | 当日已还本金（元） | 当日未还本金（元） | 借据状态 | 是否月末 |
| ------------- | ---------- | -------- | --------------- | ------------- | ------------------ | ------------------ | ------------------ | -------- | -------- |
| L202509220001 | 2025-09-22 | 1        | 2025-09-22      | 2025-10-22    | 78.85              | 0.00               | 78.85              | 正常在贷 | 否       |
| L202509220001 | 2025-09-23 | 1        | 2025-09-22      | 2025-10-22    | 78.85              | 0.00               | 78.85              | 正常在贷 | 否       |
| ...           | ...        | ...      | ...             | ...           | ...                | ...                | ...                | ...      | ...      |
| L202509220001 | 2025-10-22 | 1        | 2025-09-22      | 2025-10-22    | 78.85              | 78.85              | 0.00               | 正常结清 | 否       |
| L202509220001 | 2025-10-23 | 2        | 2025-10-22      | 2025-11-22    | 79.54              | 0.00               | 79.54              | 正常在贷 | 否       |
| ...           | ...        | ...      | ...             | ...           | ...                | ...                | ...                | ...      | ...      |
| L202509220001 | 2025-10-31 | 2        | 2025-10-22      | 2025-11-22    | 79.54              | 0.00               | 79.54              | 正常在贷 | 是       |

#### 2. 字段计算规则

- **当日未还本金**：若日期≤实还日期（2025-10-22），则为 “当期应还本金 - 累计已还本金”；若日期 > 实还日期，当期未还本金清零，切换至下一期应还本金。

- **借据状态**：日期在start_date~end_date且未到实还日→“正常在贷”；日期 = 实还日且已还本金 = 应还本金→“正常结清”；日期 > end_date 且未还本金 > 0→“逾期”。

### 四、平均本金与收益率计算：基于每日状态推导

#### 1. 平均本金计算（按年 360 天计息规则）

平均本金反映借据在计息周期内的 “日均占用本金”，是计算实际收益率的核心基础，公式为：

**平均本金 = 借据生命周期内每日未还本金之和 ÷ 360**

以借据L202509220001第 1 期（2025-09-22 至 2025-10-22，共 31 天）为例：

- 每日未还本金：2025-09-22 至 2025-10-21 共 30 天，每日未还本金 = 78.85 元；2025-10-22 未还本金 = 0 元

- 第 1 期未还本金总和 = 78.85×30 + 0 = 2365.5 元

- 若计算年度平均本金，需累加 12 期每日未还本金总和后 ÷360，最终结果接近 “（初始放款本金 + 期末剩余本金）÷2”（等额本息特性）。

#### 2. 收益率计算（年化）

收益率需结合 “实际利息收入” 与 “平均本金”，公式为：

**年化收益率 = （总实还利息 ÷ 平均本金）×（360 ÷ 借据实际存续天数）**

以该借据为例：

- 总实还利息 = 66.76 元，假设借据完整存续 12 个月（360 天），平均本金≈500 元（等额本息近似值）

- 年化收益率 = （66.76 ÷ 500）×（360 ÷ 360）≈13.35%（因等额本息本金逐期减少，实际收益率略高于名义年化 12%，符合业务规律）。

### 五、Vintage 计算：以月末观测点为例的落地实践

Vintage 核心是 “按放款月分组，追踪不同账龄（MOB）的风险表现”，结合每日状态快照与日期维度表的 “月末标记”，可高效实现计算，且完全满足 “可复现、无依赖” 要求。

#### 1. 关键定义与逻辑

- **观测点**：取每月最后一天（如 2025-10-31、2025-11-30，从日期维度表dim_date的 “是否月末” 字段筛选）。

- **账龄（MOB）**：MOB = 观测点所在月份 - 放款月份（放款月 2025-09，2025-10 观测点 MOB=1，2025-11 观测点 MOB=2，以此类推）。

- **逾期判断**：观测点日期 > 当期 end_date（应还日）且当日未还本金 > 0→判定为逾期；逾期天数 = 观测点日期 - 当期 end_date；未还本金 = 放款金额 - 累计实还本金。

#### 2. 按时还款场景下的 Vintage 示例（借据L202509220001）

| 放款月  | 观测点     | MOB  | 观测点未还本金（元） | 观测点逾期天数 | 逾期状态 | 累计实还本金（元）    | 累计实还利息（元）  |
| ------- | ---------- | ---- | -------------------- | -------------- | -------- | --------------------- | ------------------- |
| 2025-09 | 2025-10-31 | 1    | 79.54（第 2 期应还） | 0              | 正常     | 78.85                 | 10.00               |
| 2025-09 | 2025-11-30 | 2    | 80.24（第 3 期应还） | 0              | 正常     | 158.39（78.85+79.54） | 19.31（10.00+9.31） |
| 2025-09 | 2026-09-30 | 12   | 0.00（12 期已结清）  | 0              | 正常     | 1000.00               | 66.76               |

#### 3. 逾期场景下的 Vintage 修正（假设第 2 期实还日延迟至 2025-12-10）

若借据第 2 期应还日 2025-11-22 未还款，实还日为 2025-12-10，则 2025-11-30（月末观测点）状态如下：

| 放款月  | 观测点     | MOB  | 观测点未还本金（元） | 观测点逾期天数 | 逾期状态           | 累计实还本金（元） | 累计实还利息（元） |
| ------- | ---------- | ---- | -------------------- | -------------- | ------------------ | ------------------ | ------------------ |
| 2025-09 | 2025-11-30 | 2    | 79.54（第 2 期应还） | 8（30-22）     | M1（逾期 1-30 天） | 78.85              | 10.00              |

#### 4. MOB 值补充说明

原文中 “mob 值 = 未还金额 / 实放本金” 为业务简化计算方式（反映本金占用比例），标准 MOB 仍以 “账龄月份差” 为准，两者可结合使用：例如逾期场景下，MOB=2（账龄），本金占用比例 = 79.54/1000=7.95%，可同时体现在 Vintage 报表中，丰富风险维度。

### 六、数据可复现与问题排查：DWD 层每日切片的价值

为确保 Vintage 等指标 “可追溯、无歧义”，需将 DWD 层还款计划表按**每日全量切片保存**（即按etl_dt分区，每日存储当日最新的完整还款计划数据），核心价值如下：

1. **指标异常回溯**：若某期 Vintage 逾期率突增，可直接调取对应日期（如 2025-11-30）的etl_dt=2025-11-30切片，查看该日还款计划的 “应还 / 实还日期、未还本金” 是否存在数据异常（如上游系统延迟同步实还记录）。

1. **跨时间对比验证**：如需验证 “2025-10-31 观测点 MOB=1 的逾期率”，可分别调取etl_dt=2025-10-31（当日切片）和etl_dt=2026-01-01（历史回溯切片），若两者数据一致，说明指标计算无偏差，排除数据更新导致的问题。

1. **满足审计合规要求**：金融行业需保留历史数据轨迹，每日切片可完整记录借据状态的每日变化，符合监管对 “风险指标计算依据可追溯” 的要求。

# 总结：从明细到指标的闭环价值

- 通过 “还款计划表 + 日期维度表” 的组合，不仅实现了借据每日状态的精细化追踪，更让平均本金、收益率、Vintage 等核心指标的计算具备 “逻辑透明、数据可复现、问题可排查” 的特性。这种基于 DWD 层明细数据的加工方式，完全遵循数仓 “任务无依赖、数据一致性” 原则，既适配风控部门对指标精度的要求，也满足数仓工程化落地的效率需求。
